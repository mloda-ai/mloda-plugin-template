[tox]
envlist = python310

[testenv]
usedevelop = true
extras = dev
allowlist_externals = sh
commands =
    pytest
    ruff format --check --line-length 120 .
    ruff check .
    mypy --strict --ignore-missing-imports .
    bandit -c pyproject.toml -r -q .

[testenv:security]
# CVE scanning environment - downloads specific version of published package
skip_install = False
usedevelop = False
deps =
    pip-audit
allowlist_externals = sh, rm, mkdir
setenv =
    PACKAGE_NAME = {env:PACKAGE_NAME:placeholder-my-plugin}
    PACKAGE_VERSION = {env:PACKAGE_VERSION:0.2.2}
commands =
    mkdir -p security-reports

    sh -c "pip uninstall -y {env:PACKAGE_NAME} || true"

    sh -c "pip install {env:PACKAGE_NAME}=={env:PACKAGE_VERSION}"

    sh -c "pip list"

    # Run CVE scan
    sh -c "pip-audit --desc --format=json --output=security-reports/pip-audit-version.json || pip-audit --desc"

    # Display summary
    sh -c "echo '=== CVE Scan Summary ==='"
    sh -c "echo 'Tool: pip-audit (Apache 2.0 licensed)'"
    sh -c "echo 'Report: security-reports/pip-audit-version.json'"
